<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Style Diagnosis</title>
  <style>
    :root { --bg:#fafafa; --card:#fff; --text:#111; --muted:#666; --line:#ddd; }
    body { font-family: system-ui, -apple-system, Segoe UI, sans-serif; margin:0; padding:24px; background:var(--bg); color:var(--text); }
    .card { max-width: 760px; margin: 0 auto; background:var(--card); border-radius: 16px; padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .row { display:flex; gap:12px; justify-content:space-between; align-items:center; flex-wrap:wrap; }
    .muted { color:var(--muted); font-size: 14px; }
    .bar { height: 10px; background:#eee; border-radius: 999px; overflow:hidden; margin: 10px 0 6px; width:100%; }
    .bar > div { height:100%; width:0%; background:#111; transition: width .2s ease; }
    .q { font-size: 18px; margin: 14px 0 8px; }
    .choices { display:grid; gap:10px; margin: 10px 0 16px; }
    label.choice { display:block; padding:12px; border:1px solid var(--line); border-radius: 12px; cursor:pointer; background:#fff; }
    label.choice:hover { background:#f7f7f7; }
    input { margin-right: 8px; }
    .btns { display:flex; gap:10px; justify-content:space-between; }
    button { padding: 10px 14px; border-radius: 12px; border: 1px solid var(--line); background: #f5f5f5; cursor:pointer; }
    button.primary { background:#111; color:#fff; border-color:#111; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#f2f2f2; margin-right:6px; }
    .result { display:none; }
    .quiz { display:none; }
    .start { display:block; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; width:100%; }
    .box { border:1px solid var(--line); border-radius:12px; padding:12px; background:#fff; }
    .small { font-size:12px; color:var(--muted); }
    .scoreline { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; color:var(--muted); }
    @media (max-width: 720px) { .grid2 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="card">
    <div class="row">
      <div>
        <h2 id="title" style="margin:0;">Style Diagnosis</h2>
        <div class="muted" id="subtitle">約2分で終わります</div>
      </div>
      <div class="muted" id="step"></div>
    </div>

    <!-- START SCREEN -->
    <div id="start" class="start" style="margin-top:14px;">
      <div class="grid2">
        <div class="box">
          <div style="font-weight:700; margin-bottom:6px;">診断タイプ数</div>
          <label style="display:block; margin:6px 0;">
            <input type="radio" name="mode" value="9" checked>
            9タイプ（クリーン/カジュアル/ストリート/スポーティ/モード/アメカジ/アウトドア/韓国系/古着）
          </label>
          <label style="display:block; margin:6px 0;">
            <input type="radio" name="mode" value="8">
            8タイプ（アメカジ＋古着 を統合）
          </label>
          <div class="small">※URLに <b>?mode=8</b> を付けると、開いた瞬間から8タイプ固定にもできます。</div>
        </div>

        <div class="box">
          <div style="font-weight:700; margin-bottom:6px;">使い方</div>
          <div class="muted">12問・各4択。直感で選んでOK。</div>
          <div class="muted">結果は「メインタイプ」＋差が小さければ「ミックス傾向」も表示します。</div>
          <div style="margin-top:12px;">
            <button id="startBtn" class="primary">診断をはじめる</button>
          </div>
        </div>
      </div>
    </div>

    <!-- QUIZ -->
    <div class="bar"><div id="progress"></div></div>

    <div id="quiz" class="quiz">
      <div class="q" id="qText"></div>
      <div class="choices" id="choices"></div>

      <div class="btns">
        <button id="backBtn">戻る</button>
        <button id="nextBtn" class="primary" disabled>次へ</button>
      </div>
    </div>

    <!-- RESULT -->
    <div id="result" class="result">
      <h3 style="margin-top:0;">診断結果</h3>
      <div id="resultMain" style="font-size:20px; margin: 8px 0;"></div>
      <div id="resultMix" class="muted" style="margin-bottom: 12px;"></div>
      <div class="muted" id="resultExplain" style="margin-bottom: 10px;"></div>

      <div class="muted" style="margin-top:6px;">（研究用：スコア）</div>
      <div id="resultScores" class="scoreline"></div>

      <div style="margin-top:16px;">
        <button id="restartBtn">もう一回</button>
      </div>
    </div>
  </div>

  <!-- ここが「JSON方式」：設定をHTML内に埋め込み -->
  <script id="quizConfig" type="application/json">
{
  "version": "1.0",
  "title": "Style Diagnosis",
  "timeEstimateSec": 120,
  "mixThreshold": 2,
  "useEightTypes": false,
  "mergeRules": { "AME_VIN": ["AME", "VIN"] },
  "types": [
    { "id": "CLN", "label": "きれいめ（クリーン）" },
    { "id": "CAS", "label": "カジュアル" },
    { "id": "STR", "label": "ストリート" },
    { "id": "SPT", "label": "スポーティ（アスレジャー）" },
    { "id": "MOD", "label": "モード" },
    { "id": "AME", "label": "アメカジ" },
    { "id": "OUT", "label": "アウトドア" },
    { "id": "KOR", "label": "韓国系" },
    { "id": "VIN", "label": "古着系（ヴィンテージ）" }
  ],
  "tieBreakPriority": ["Q10", "Q7", "Q1"],
  "typeDescriptions": {
    "CLN": "シャツ/スラックス/ローファーなど、清潔感と整い重視。シンプル配色が得意。",
    "CAS": "デニム/スウェット/パーカーなど、自然体で着回し重視。定番スニーカーが合う。",
    "STR": "オーバーサイズ/ロゴ/カーゴなど、存在感と今っぽさ重視。ボリューム足元がハマる。",
    "SPT": "ジャージ/ナイロン/テック素材など、快適さと機能性重視。走れる/歩けるが正義。",
    "MOD": "黒多め/ミニマル/デザイン強め。細身or極端シルエットで雰囲気を作る。",
    "AME": "デニム/チェック/ワーク感。王道アメリカンカジュアル寄り。",
    "OUT": "マウンパ/フリース/機能重視。天候対応や耐久性もポイント。",
    "KOR": "淡色/短丈×ワイド/セットアップなど。きれいめストリート寄りの今っぽさ。",
    "VIN": "レトロ柄/色褪せ/リメイク/年代MIX。古着っぽい味が好き。"
  },
  "questions": [
    {
      "id": "Q1",
      "text": "好きなシルエットは？",
      "choices": [
        { "key": "A", "text": "ジャスト〜細め", "score": { "CLN": 3, "MOD": 2, "KOR": 1 } },
        { "key": "B", "text": "ほどよくゆるめ", "score": { "CAS": 3, "AME": 2, "VIN": 1 } },
        { "key": "C", "text": "オーバーサイズ", "score": { "STR": 3, "CAS": 1, "OUT": 1 } },
        { "key": "D", "text": "短丈×ワイド（メリハリ）", "score": { "KOR": 3, "STR": 2, "MOD": 1 } }
      ]
    },
    {
      "id": "Q2",
      "text": "よく使う色は？",
      "choices": [
        { "key": "A", "text": "黒・グレー中心", "score": { "MOD": 3, "CLN": 2 } },
        { "key": "B", "text": "白黒＋ベーシック（ネイビー/ベージュ）", "score": { "CLN": 3, "CAS": 2, "AME": 1 } },
        { "key": "C", "text": "淡色（アイボリー/ライトグレー/パステル）", "score": { "KOR": 3, "CLN": 1 } },
        { "key": "D", "text": "差し色/濃色/柄も好き", "score": { "STR": 3, "VIN": 2, "AME": 1 } }
      ]
    },
    {
      "id": "Q3",
      "text": "よく着るトップスは？",
      "choices": [
        { "key": "A", "text": "シャツ/きれいめニット", "score": { "CLN": 3, "MOD": 2 } },
        { "key": "B", "text": "スウェット/パーカー", "score": { "CAS": 3, "AME": 2, "STR": 1 } },
        { "key": "C", "text": "ロゴT/グラフィック", "score": { "STR": 3, "VIN": 2 } },
        { "key": "D", "text": "ジャージ/機能T", "score": { "SPT": 3, "OUT": 2 } }
      ]
    },
    {
      "id": "Q4",
      "text": "いちばん好きなアウターは？",
      "choices": [
        { "key": "A", "text": "テーラード/コート", "score": { "CLN": 3, "MOD": 2 } },
        { "key": "B", "text": "デニムジャケット/ワーク系", "score": { "AME": 3, "VIN": 2 } },
        { "key": "C", "text": "ダウン/ボリュームアウター", "score": { "STR": 3, "CAS": 1 } },
        { "key": "D", "text": "マウンパ/フリース", "score": { "OUT": 3, "SPT": 2 } }
      ]
    },
    {
      "id": "Q5",
      "text": "ボトムの定番は？",
      "choices": [
        { "key": "A", "text": "スラックス", "score": { "CLN": 3, "MOD": 2, "KOR": 1 } },
        { "key": "B", "text": "デニム", "score": { "AME": 3, "CAS": 2, "VIN": 2 } },
        { "key": "C", "text": "カーゴ/ワイド", "score": { "STR": 3, "OUT": 2 } },
        { "key": "D", "text": "ナイロン/ジャージパンツ", "score": { "SPT": 3, "OUT": 1, "STR": 1 } }
      ]
    },
    {
      "id": "Q6",
      "text": "靴の好みは？",
      "choices": [
        { "key": "A", "text": "革靴/ローファー寄り", "score": { "CLN": 3, "MOD": 2 } },
        { "key": "B", "text": "シンプルなスニーカー", "score": { "CAS": 3, "CLN": 1, "AME": 1 } },
        { "key": "C", "text": "厚底/ボリューム系", "score": { "STR": 3, "KOR": 2 } },
        { "key": "D", "text": "ランニング/トレイル系", "score": { "SPT": 3, "OUT": 2 } }
      ]
    },
    {
      "id": "Q7",
      "text": "服選びで一番大事なのは？",
      "choices": [
        { "key": "A", "text": "きちんと見え・清潔感", "score": { "CLN": 3, "MOD": 2 } },
        { "key": "B", "text": "着回し・ラクさ", "score": { "CAS": 3, "AME": 2 } },
        { "key": "C", "text": "盛れる・存在感", "score": { "STR": 3, "KOR": 2, "VIN": 1 } },
        { "key": "D", "text": "機能（軽い/動ける/天候対応）", "score": { "OUT": 3, "SPT": 2 } }
      ]
    },
    {
      "id": "Q8",
      "text": "好きな素材感は？",
      "choices": [
        { "key": "A", "text": "上質・ツルっと/落ち感", "score": { "MOD": 3, "CLN": 2 } },
        { "key": "B", "text": "コットン・裏毛・デニム", "score": { "AME": 3, "CAS": 2 } },
        { "key": "C", "text": "テック素材（ナイロン/リップストップ）", "score": { "SPT": 3, "OUT": 2, "STR": 1 } },
        { "key": "D", "text": "古着っぽい風合い（色褪せ/加工）", "score": { "VIN": 3, "AME": 2, "STR": 1 } }
      ]
    },
    {
      "id": "Q9",
      "text": "柄・デザインの好みは？",
      "choices": [
        { "key": "A", "text": "無地・ミニマル", "score": { "CLN": 3, "MOD": 2 } },
        { "key": "B", "text": "チェック/ワークっぽい", "score": { "AME": 3, "VIN": 2 } },
        { "key": "C", "text": "ロゴ/グラフィック強め", "score": { "STR": 3, "KOR": 1 } },
        { "key": "D", "text": "レトロ柄/年代MIX", "score": { "VIN": 3, "AME": 1, "CAS": 1 } }
      ]
    },
    {
      "id": "Q10",
      "text": "コーデの主役は？",
      "choices": [
        { "key": "A", "text": "全体の整い（品）", "score": { "CLN": 3, "MOD": 2 } },
        { "key": "B", "text": "ラフな雰囲気", "score": { "CAS": 3, "AME": 1 } },
        { "key": "C", "text": "シルエット/ロゴのインパクト", "score": { "STR": 3, "KOR": 2 } },
        { "key": "D", "text": "走れる・動ける実用", "score": { "SPT": 3, "OUT": 2 } }
      ]
    },
    {
      "id": "Q11",
      "text": "“よくいる場所”に近いのは？",
      "choices": [
        { "key": "A", "text": "きれいめな街/お店", "score": { "CLN": 3, "MOD": 1 } },
        { "key": "B", "text": "カフェ・買い物・友達とゆるく", "score": { "CAS": 3, "KOR": 1, "AME": 1 } },
        { "key": "C", "text": "イベント/ライブ/写真撮る", "score": { "STR": 3, "KOR": 2 } },
        { "key": "D", "text": "外・移動多め（天気関係なく）", "score": { "OUT": 3, "SPT": 2 } }
      ]
    },
    {
      "id": "Q12",
      "text": "憧れるスタイルは？",
      "choices": [
        { "key": "A", "text": "端正・ミニマル", "score": { "MOD": 3, "CLN": 2 } },
        { "key": "B", "text": "王道カジュアル", "score": { "CAS": 3, "AME": 2 } },
        { "key": "C", "text": "スケボー/ストリート感", "score": { "STR": 3, "VIN": 1 } },
        { "key": "D", "text": "アスレジャー/テック感", "score": { "SPT": 3, "OUT": 2 } }
      ]
    }
  ]
}
  </script>

  <script>
    // =========================
    //  アプリ本体（HTML内JS）
    // =========================
    const el = {
      title: document.getElementById("title"),
      subtitle: document.getElementById("subtitle"),
      step: document.getElementById("step"),
      progress: document.getElementById("progress"),
      start: document.getElementById("start"),
      startBtn: document.getElementById("startBtn"),
      quiz: document.getElementById("quiz"),
      qText: document.getElementById("qText"),
      choices: document.getElementById("choices"),
      backBtn: document.getElementById("backBtn"),
      nextBtn: document.getElementById("nextBtn"),
      result: document.getElementById("result"),
      resultMain: document.getElementById("resultMain"),
      resultMix: document.getElementById("resultMix"),
      resultExplain: document.getElementById("resultExplain"),
      resultScores: document.getElementById("resultScores"),
      restartBtn: document.getElementById("restartBtn")
    };

    const state = { idx: 0, answers: [], config: null, mode: 9 };

    function parseConfig() {
      const raw = document.getElementById("quizConfig").textContent.trim();
      const cfg = JSON.parse(raw);
      return cfg;
    }

    function getUrlMode() {
      const p = new URLSearchParams(location.search);
      const mode = p.get("mode");
      return mode === "8" ? 8 : null;
    }

    function applyMode(cfg, mode) {
      // mode: 9 or 8
      cfg = structuredClone(cfg);
      cfg.useEightTypes = (mode === 8);
      return cfg;
    }

    function init() {
      const cfg = parseConfig();
      const urlMode = getUrlMode();
      if (urlMode === 8) {
        // UIも8に合わせる
        document.querySelector('input[name="mode"][value="8"]').checked = true;
        state.mode = 8;
      } else {
        state.mode = 9;
      }

      state.config = applyMode(cfg, state.mode);
      el.title.textContent = state.config.title || "Style Diagnosis";
      el.subtitle.textContent = `約${Math.round((state.config.timeEstimateSec || 120) / 60)}分で終わります`;

      state.answers = new Array(state.config.questions.length).fill(null);

      bindEvents();
      el.step.textContent = "";
      el.progress.style.width = "0%";
    }

    function bindEvents() {
      // モード変更
      document.querySelectorAll('input[name="mode"]').forEach(r => {
        r.addEventListener("change", () => {
          state.mode = Number(document.querySelector('input[name="mode"]:checked').value);
          const base = parseConfig();
          state.config = applyMode(base, state.mode);
          state.answers = new Array(state.config.questions.length).fill(null);
          state.idx = 0;
          el.step.textContent = "";
          el.progress.style.width = "0%";
        });
      });

      el.startBtn.addEventListener("click", () => {
        state.idx = 0;
        el.start.style.display = "none";
        el.quiz.style.display = "block";
        el.result.style.display = "none";
        render();
      });

      el.backBtn.addEventListener("click", () => {
        if (state.idx > 0) {
          state.idx--;
          render();
        }
      });

      el.nextBtn.addEventListener("click", () => {
        const total = state.config.questions.length;
        if (state.idx < total - 1) {
          state.idx++;
          render();
          return;
        }
        const result = calculateResult();
        showResult(result);
      });

      el.restartBtn.addEventListener("click", () => {
        state.idx = 0;
        state.answers.fill(null);
        el.result.style.display = "none";
        el.quiz.style.display = "none";
        el.start.style.display = "block";
        el.step.textContent = "";
        el.progress.style.width = "0%";
      });
    }

    function render() {
      const cfg = state.config;
      const total = cfg.questions.length;
      const q = cfg.questions[state.idx];

      el.step.textContent = `${state.idx + 1} / ${total}`;
      el.progress.style.width = `${Math.round(((state.idx + 1) / total) * 100)}%`;

      el.qText.textContent = `${q.id}. ${q.text}`;
      el.choices.innerHTML = "";

      const selected = state.answers[state.idx];

      q.choices.forEach(choice => {
        const id = `${q.id}_${choice.key}`;
        const label = document.createElement("label");
        label.className = "choice";
        label.htmlFor = id;

        const input = document.createElement("input");
        input.type = "radio";
        input.name = "choice";
        input.id = id;
        input.value = choice.key;
        input.checked = selected === choice.key;

        input.addEventListener("change", () => {
          state.answers[state.idx] = choice.key;
          el.nextBtn.disabled = false;
        });

        label.appendChild(input);
        label.appendChild(document.createTextNode(`${choice.key}. ${choice.text}`));
        el.choices.appendChild(label);
      });

      el.backBtn.disabled = (state.idx === 0);
      el.nextBtn.textContent = (state.idx === total - 1) ? "結果を見る" : "次へ";
      el.nextBtn.disabled = !state.answers[state.idx];
    }

    function calculateResult() {
      const cfg = state.config;

      // スコア初期化
      const typeIds = cfg.types.map(t => t.id);
      const scores = Object.fromEntries(typeIds.map(id => [id, 0]));

      // 回答加点
      cfg.questions.forEach((q, i) => {
        const ans = state.answers[i];
        if (!ans) return;
        const choice = q.choices.find(c => c.key === ans);
        if (!choice) return;

        const sc = choice.score || {};
        Object.entries(sc).forEach(([typeId, pts]) => {
          if (scores[typeId] != null) scores[typeId] += pts;
        });
      });

      // 8タイプ統合（AME + VIN → AME_VIN）
      let finalTypes = cfg.types;
      let finalScores = { ...scores };

      if (cfg.useEightTypes) {
        const mergedId = "AME_VIN";
        finalScores[mergedId] = (finalScores["AME"] || 0) + (finalScores["VIN"] || 0);
        delete finalScores["AME"];
        delete finalScores["VIN"];

        finalTypes = cfg.types
          .filter(t => t.id !== "AME" && t.id !== "VIN")
          .concat([{ id: mergedId, label: "アメカジ・古着" }]);
      }

      const sorted = Object.entries(finalScores)
        .map(([id, score]) => ({ id, score }))
        .sort((a, b) => b.score - a.score);

      const topScore = sorted[0].score;
      const tiedTop = sorted.filter(x => x.score === topScore).map(x => x.id);

      const mainId = tiedTop.length > 1 ? breakTie(tiedTop, finalScores) : sorted[0].id;

      const mainObj = sorted.find(x => x.id === mainId);
      const secondObj = sorted.find(x => x.id !== mainId);
      const mix =
        secondObj && (mainObj.score - secondObj.score) <= (cfg.mixThreshold ?? 2)
          ? secondObj.id
          : null;

      const mainLabel = (finalTypes.find(t => t.id === mainId) || { label: mainId }).label;
      const mixLabel = mix ? (finalTypes.find(t => t.id === mix) || { label: mix }).label : null;

      return { mainId, mainLabel, mixId: mix, mixLabel, sorted, finalTypes };
    }

    function breakTie(tiedTypeIds) {
      const cfg = state.config;
      for (const qid of cfg.tieBreakPriority || []) {
        const qIndex = cfg.questions.findIndex(q => q.id === qid);
        if (qIndex === -1) continue;
        const ans = state.answers[qIndex];
        if (!ans) continue;

        const q = cfg.questions[qIndex];
        const choice = q.choices.find(c => c.key === ans);
        const sc = choice?.score || {};

        let best = tiedTypeIds[0];
        let bestPts = sc[best] ?? 0;

        for (const tid of tiedTypeIds.slice(1)) {
          const pts = sc[tid] ?? 0;
          if (pts > bestPts) { best = tid; bestPts = pts; }
        }

        const topPtsCount = tiedTypeIds.filter(tid => (sc[tid] ?? 0) === bestPts).length;
        if (topPtsCount === 1) return best;
      }

      // 固定順
      const order = cfg.useEightTypes
        ? cfg.types.filter(t => t.id !== "AME" && t.id !== "VIN").map(t => t.id).concat(["AME_VIN"])
        : cfg.types.map(t => t.id);

      for (const id of order) if (tiedTypeIds.includes(id)) return id;
      return tiedTypeIds[0];
    }

    function showResult(result) {
      const cfg = state.config;

      el.quiz.style.display = "none";
      el.result.style.display = "block";

      el.resultMain.innerHTML = `<span class="pill">メイン</span> ${result.mainLabel}`;
      el.resultMix.textContent = result.mixLabel ? `ミックス傾向：${result.mixLabel} も強め` : "";

      // 説明文
      const desc = cfg.typeDescriptions || {};
      const mainDesc = desc[result.mainId] || "";
      const mixDesc = result.mixId ? (desc[result.mixId] || "") : "";
      el.resultExplain.textContent =
        result.mixId
          ? `特徴：${mainDesc} /（ミックス）${mixDesc}`
          : `特徴：${mainDesc}`;

      // スコア表示
      el.resultScores.textContent = result.sorted.map(x => `${x.id}:${x.score}`).join("  /  ");
    }

    init();
  </script>
</body>
</html>
